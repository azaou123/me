<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Portfolio Chat Assistant</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --user-message-bg: linear-gradient(135deg, #4361ee, #7209b7);
            --bot-message-bg: #ffffff;
            --error-color: #e63946;
            --success-color: #2a9d8f;
            --warning-color: #f77f00;
            --border-color: #e9ecef;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .header h1 {
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 60vh;
            min-height: 400px;
        }

        .message {
            border-radius: 18px;
            padding: 14px 18px;
            margin: 10px 0;
            max-width: 85%;
            position: relative;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: var(--user-message-bg);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background: var(--bot-message-bg);
            color: var(--dark-color);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            background: var(--bot-message-bg);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            animation: messageSlide 0.3s ease-out;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.95);
            padding: 16px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper textarea {
            width: 100%;
            border-radius: 16px;
            padding: 12px 50px 12px 16px;
            border: 2px solid var(--border-color);
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: inherit;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .input-wrapper textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            outline: none;
        }

        .char-counter {
            position: absolute;
            bottom: 8px;
            right: 16px;
            font-size: 0.75rem;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 8px;
        }

        .btn-send {
            background: var(--user-message-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-send:hover:not(:disabled) {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-clear {
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-clear:hover {
            background: #e56b00;
            transform: translateY(-1px);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 6px;
            text-align: right;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .error-message {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            animation: messageSlide 0.3s ease-out;
        }

        .success-message {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            animation: messageSlide 0.3s ease-out;
        }

        .welcome-message {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 16px;
            border: 1px solid rgba(67, 97, 238, 0.2);
        }

        .concise-response {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .highlight {
            background: linear-gradient(120deg, rgba(67, 97, 238, 0.2), rgba(114, 9, 183, 0.2));
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .divider {
            border-top: 1px solid var(--border-color);
            margin: 16px 0;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-send.loading .spinner { display: inline-block; }
        .btn-send.loading i { display: none; }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: var(--success-color);
            color: white;
        }

        .connection-status.offline {
            background: var(--error-color);
            color: white;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container { padding: 10px; }
            .chat-container { 
                padding: 15px; 
                max-height: 50vh;
                min-height: 300px;
            }
            .message { 
                max-width: 95%; 
                padding: 12px 16px; 
            }
            .input-container { padding: 12px; }
            .btn-send { width: 48px; height: 48px; }
            .quick-actions { justify-content: center; }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .bot-message {
                background: #2d3748;
                color: #e2e8f0;
                border-color: #4a5568;
            }
            .input-wrapper textarea {
                background: #2d3748;
                color: #e2e8f0;
                border-color: #4a5568;
            }
        }

        /* Custom scrollbar */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="connection-status" id="connectionStatus">
            <i class="fas fa-wifi"></i> Checking connection...
        </div>

        <div class="header">
            <h1><i class="fas fa-robot"></i> Portfolio Assistant</h1>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="statusText">Ready to help</span>
            </div>
        </div>

        <div class="chat-wrapper">
            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <h4><i class="fas fa-wave-square"></i> Welcome!</h4>
                    <p>I'm your AI portfolio assistant. I can help you learn about Badr's skills, experience, and projects.</p>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="sendQuickMessage('Tell me about your skills')">
                            <i class="fas fa-code"></i> Skills
                        </button>
                        <button class="quick-btn" onclick="sendQuickMessage('What projects have you worked on?')">
                            <i class="fas fa-project-diagram"></i> Projects
                        </button>
                        <button class="quick-btn" onclick="sendQuickMessage('What is your experience?')">
                            <i class="fas fa-briefcase"></i> Experience
                        </button>
                        <button class="quick-btn" onclick="sendQuickMessage('How can I contact you?')">
                            <i class="fas fa-envelope"></i> Contact
                        </button>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <button class="btn-clear" id="clearButton" title="Clear chat">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <div class="input-wrapper">
                    <textarea 
                        id="userInput" 
                        placeholder="Ask me anything about the portfolio..." 
                        rows="1"
                        maxlength="500"
                    ></textarea>
                    <div class="char-counter" id="charCounter">0/500</div>
                </div>
                <button class="btn-send" id="sendButton" disabled title="Send message">
                    <i class="fas fa-paper-plane"></i>
                    <span class="spinner"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class PortfolioChat {
            constructor() {
                this.chatContainer = document.getElementById('chatContainer');
                this.userInput = document.getElementById('userInput');
                this.sendButton = document.getElementById('sendButton');
                this.clearButton = document.getElementById('clearButton');
                this.charCounter = document.getElementById('charCounter');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.statusText = document.getElementById('statusText');
                
                this.apiKey = 'AIzaSyBzm9whwtPcdFsNaChNIvoYLShIR7_lVn8';
                this.portfolioFileUrl = 'https://azaou123.github.io/me/me.txt';
                this.portfolioContent = '';
                this.conversationHistory = [];
                this.isWaitingForResponse = false;
                this.maxRetries = 3;
                this.retryDelay = 1000;
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setupAutoResize();
                this.checkConnection();
                await this.loadPortfolioContent();
                this.updateStatus('Ready to chat!', 'success');
            }

            setupEventListeners() {
                this.userInput.addEventListener('input', () => this.handleInput());
                this.userInput.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.clearButton.addEventListener('click', () => this.clearChat());
                
                // Auto-save conversation
                window.addEventListener('beforeunload', () => this.saveConversation());
                
                // Load saved conversation
                this.loadConversation();
            }

            setupAutoResize() {
                this.userInput.addEventListener('input', () => {
                    this.userInput.style.height = 'auto';
                    this.userInput.style.height = Math.min(this.userInput.scrollHeight, 120) + 'px';
                });
            }

            handleInput() {
                const value = this.userInput.value;
                const length = value.length;
                
                this.charCounter.textContent = `${length}/500`;
                this.charCounter.style.color = length > 450 ? '#e63946' : '#666';
                
                this.sendButton.disabled = value.trim() === '' || this.isWaitingForResponse || length > 500;
            }

            handleKeydown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!this.sendButton.disabled) {
                        this.sendMessage();
                    }
                }
            }

            async checkConnection() {
                try {
                    const response = await fetch('https://www.google.com/favicon.ico', { 
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    this.updateConnectionStatus(true);
                } catch (error) {
                    this.updateConnectionStatus(false);
                }
            }

            updateConnectionStatus(isOnline) {
                this.connectionStatus.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
                this.connectionStatus.innerHTML = `
                    <i class="fas fa-${isOnline ? 'wifi' : 'wifi-slash'}"></i> 
                    ${isOnline ? 'Online' : 'Offline'}
                `;
            }

            updateStatus(message, type = 'info') {
                this.statusText.textContent = message;
                this.statusText.className = type;
            }

            getCurrentTime() {
                return new Date().toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            addMessage(content, isUser, options = {}) {
                const messageDiv = document.createElement('div');
                
                if (options.isTyping) {
                    messageDiv.className = 'typing-indicator';
                    messageDiv.id = 'typingIndicator';
                    messageDiv.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                } else {
                    messageDiv.className = isUser ? 'user-message message' : 'bot-message message';
                    messageDiv.innerHTML = `
                        <div class="message-content">${content}</div>
                        <div class="message-time">${this.getCurrentTime()}</div>
                        ${!isUser ? `
                            <div class="message-actions">
                                <button class="action-btn" onclick="copyMessage(this)" title="Copy">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="action-btn" onclick="shareMessage(this)" title="Share">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        ` : ''}
                    `;
                    
                    if (!options.skipHistory) {
                        this.conversationHistory.push({
                            role: isUser ? 'user' : 'assistant',
                            content: content,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
                
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                return messageDiv;
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                }, 100);
            }

            showMessage(content, type = 'error') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `${type}-message`;
                messageDiv.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    ${content}
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }

            async loadPortfolioContent() {
                this.updateStatus('Loading portfolio data...', 'loading');
                
                try {
                    const response = await this.fetchWithRetry(this.portfolioFileUrl);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    this.portfolioContent = await response.text();
                    this.updateStatus('Portfolio data loaded', 'success');
                    console.log('Portfolio content loaded successfully');
                    
                } catch (error) {
                    console.error('Failed to load portfolio content:', error);
                    this.portfolioContent = `
                        I'm Badr AZAOU, a software developer with expertise in:
                        - Frontend: React, Vue.js, JavaScript, HTML5, CSS3
                        - Backend: Node.js, Python, PHP
                        - Databases: MySQL, MongoDB
                        - Tools: Git, Docker, AWS
                        
                        Portfolio data could not be fully loaded, but I can still answer general questions about development work.
                    `;
                    this.showMessage('Note: Some portfolio information might be limited due to connection issues.', 'error');
                    this.updateStatus('Limited data available', 'warning');
                }
            }

            async fetchWithRetry(url, options = {}, retries = this.maxRetries) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Accept': 'text/plain, */*',
                            'Cache-Control': 'no-cache',
                            ...options.headers
                        }
                    });
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        console.log(`Retrying... ${retries} attempts left`);
                        await new Promise(resolve => setTimeout(resolve, this.retryDelay));
                        return this.fetchWithRetry(url, options, retries - 1);
                    }
                    throw error;
                }
            }

            async getGeminiResponse(message) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${this.apiKey}`;
                
                const prompt = `You are Badr AZAOU's AI portfolio assistant. When answering questions:

1. FIRST provide a brief, direct answer in <concise> tags (1-2 sentences max)
2. Then provide detailed information if needed
3. Format technical terms with <highlight> tags
4. Use professional but friendly tone
5. Be conversational and helpful
6. If info isn't in portfolio, make reasonable inferences based on context

Portfolio Information:
${this.portfolioContent}

Previous conversation context:
${this.conversationHistory.slice(-4).map(h => `${h.role}: ${h.content}`).join('\n')}

Current Question: ${message}

Example Response Format:
<concise>Based on the portfolio, Badr specializes in full-stack web development with React and Node.js.</concise>

<divider></divider>

More details:
- <highlight>Frontend</highlight>: React, Vue.js, modern JavaScript
- <highlight>Backend</highlight>: Node.js, Python, RESTful APIs
- <highlight>Database</highlight>: MySQL, MongoDB
- Experience with cloud deployment and DevOps practices`;

                const response = await this.fetchWithRetry(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topP: 0.8,
                            maxOutputTokens: 800,
                            stopSequences: []
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response format from API');
                }
                
                let botResponse = data.candidates[0].content.parts[0].text;
                
                // Format the response for HTML display
                botResponse = botResponse
                    .replace(/<concise>(.*?)<\/concise>/gs, '<div class="concise-response">ðŸ’¡ $1</div>')
                    .replace(/<highlight>(.*?)<\/highlight>/g, '<span class="highlight">$1</span>')
                    .replace(/<divider><\/divider>/g, '<div class="divider"></div>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n- /g, '<br>â€¢ ')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
                
                return botResponse;
            }

            async sendMessage(message = null) {
                const messageText = message || this.userInput.value.trim();
                if (!messageText || this.isWaitingForResponse) return;

                this.isWaitingForResponse = true;
                this.sendButton.disabled = true;
                this.sendButton.classList.add('loading');
                this.updateStatus('Thinking...', 'loading');
                
                this.addMessage(messageText, true);
                if (!message) {
                    this.userInput.value = '';
                    this.userInput.style.height = 'auto';
                    this.handleInput();
                }
                
                const typingIndicator = this.addMessage('', false, { isTyping: true });
                
                try {
                    const botResponse = await this.getGeminiResponse(messageText);
                    this.removeTypingIndicator();
                    this.addMessage(botResponse, false);
                    this.updateStatus('Ready to chat!', 'success');
                    
                } catch (error) {
                    this.removeTypingIndicator();
                    console.error('Chat Error:', error);
                    
                    let errorMessage = 'Sorry, I encountered an issue. ';
                    
                    if (error.message.includes('API Error: 4')) {
                        errorMessage += 'API key issue. Please check your configuration.';
                    } else if (error.message.includes('network')) {
                        errorMessage += 'Network connection problem. Please check your internet.';
                    } else if (error.message.includes('quota')) {
                        errorMessage += 'API quota exceeded. Please try again later.';
                    } else {
                        errorMessage += 'Please try again in a moment.';
                    }
                    
                    this.showMessage(errorMessage, 'error');
                    this.updateStatus('Error occurred', 'error');
                    
                } finally {
                    this.isWaitingForResponse = false;
                    this.sendButton.disabled = this.userInput.value.trim() === '';
                    this.sendButton.classList.remove('loading');
                    this.userInput.focus();
                }
            }

            clearChat() {
                if (confirm('Are you sure you want to clear the chat history?')) {
                    this.chatContainer.innerHTML = `
                        <div class="welcome-message">
                            <h4><i class="fas fa-wave-square"></i> Chat Cleared!</h4>
                            <p>Ready for a fresh conversation. What would you like to know?</p>
                            
                            <div class="quick-actions">
                                <button class="quick-btn" onclick="sendQuickMessage('Tell me about your skills')">
                                    <i class="fas fa-code"></i> Skills
                                </button>
                                <button class="quick-btn" onclick="sendQuickMessage('What projects have you worked on?')">
                                    <i class="fas fa-project-diagram"></i> Projects
                                </button>
                                <button class="quick-btn" onclick="sendQuickMessage('What is your experience?')">
                                    <i class="fas fa-briefcase"></i> Experience
                                </button>
                                <button class="quick-btn" onclick="sendQuickMessage('How can I contact you?')">
                                    <i class="fas fa-envelope"></i> Contact
                                </button>
                            </div>
                        </div>
                    `;
                    this.conversationHistory = [];
                    this.updateStatus('Chat cleared', 'success');
                    this.showMessage('Chat history cleared successfully!', 'success');
                }
            }

            saveConversation() {
                try {
                    const data = {
                        history: this.conversationHistory,
                        timestamp: new Date().toISOString()
                    };
                    // Note: Using in-memory storage as localStorage is not supported
                    this.savedConversation = data;
                } catch (error) {
                    console.warn('Could not save conversation:', error);
                }
            }

            loadConversation() {
                try {
                    // Note: Using in-memory storage as localStorage is not supported
                    if (this.savedConversation && this.savedConversation.history) {
                        this.conversationHistory = this.savedConversation.history;
                        
                        // Restore messages (limit to last 10 for performance)
                        const recentHistory = this.conversationHistory.slice(-10);
                        recentHistory.forEach(msg => {
                            this.addMessage(msg.content, msg.role === 'user', { skipHistory: true });
                        });
                        
                        if (recentHistory.length > 0) {
                            this.showMessage('Previous conversation restored!', 'success');
                        }
                    }
                } catch (error) {
                    console.warn('Could not load conversation:', error);
                }
            }

            // Export conversation
            exportConversation() {
                const data = {
                    conversation: this.conversationHistory,
                    exportDate: new Date().toISOString(),
                    portfolioAssistant: 'Badr AZAOU'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-chat-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('Conversation exported successfully!', 'success');
            }
        }

        // Global functions for quick actions and message actions
        function sendQuickMessage(message) {
            const chat = window.portfolioChat;
            if (chat && !chat.isWaitingForResponse) {
                chat.sendMessage(message);
            }
        }

        function copyMessage(button) {
            const messageContent = button.closest('.message').querySelector('.message-content').textContent;
            navigator.clipboard.writeText(messageContent).then(() => {
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            }).catch(() => {
                alert('Copy failed. Please select and copy manually.');
            });
        }

        function shareMessage(button) {
            const messageContent = button.closest('.message').querySelector('.message-content').textContent;
            if (navigator.share) {
                navigator.share({
                    title: 'Portfolio Assistant Response',
                    text: messageContent,
                    url: window.location.href
                }).catch(console.error);
            } else {
                copyMessage(button);
                alert('Message copied to clipboard!');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K to focus input
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('userInput').focus();
            }
            
            // Ctrl/Cmd + L to clear chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                window.portfolioChat.clearChat();
            }
            
            // Ctrl/Cmd + E to export conversation
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                window.portfolioChat.exportConversation();
            }
        });

        // Enhanced error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            if (window.portfolioChat) {
                window.portfolioChat.showMessage('An unexpected error occurred. Please refresh the page if issues persist.', 'error');
            }
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            if (window.portfolioChat) {
                window.portfolioChat.showMessage('A network error occurred. Please check your connection.', 'error');
            }
        });

        // Initialize the chat when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.portfolioChat = new PortfolioChat();
            
            // Add export button to clear button area
            const clearButton = document.getElementById('clearButton');
            const exportButton = document.createElement('button');
            exportButton.className = 'btn-clear';
            exportButton.innerHTML = '<i class="fas fa-download"></i> Export';
            exportButton.title = 'Export conversation';
            exportButton.onclick = () => window.portfolioChat.exportConversation();
            clearButton.parentNode.insertBefore(exportButton, clearButton);
            
            // Add helpful tooltips
            const tooltips = [
                { selector: '#userInput', text: 'Type your message here (Ctrl+K to focus)' },
                { selector: '#clearButton', text: 'Clear chat history (Ctrl+L)' },
                { selector: '#sendButton', text: 'Send message (Enter)' }
            ];
            
            tooltips.forEach(({ selector, text }) => {
                const element = document.querySelector(selector);
                if (element && !element.title) {
                    element.title = text;
                }
            });
        });

        // Add some helpful CSS animations
        const style = document.createElement('style');
        style.textContent = `
            .pulse-success {
                animation: pulseSuccess 0.6s ease-in-out;
            }
            
            @keyframes pulseSuccess {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); background-color: var(--success-color); }
                100% { transform: scale(1); }
            }
            
            .shake-error {
                animation: shakeError 0.5s ease-in-out;
            }
            
            @keyframes shakeError {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            .message-appear {
                animation: messageAppear 0.4s ease-out;
            }
            
            @keyframes messageAppear {
                0% {
                    opacity: 0;
                    transform: translateY(20px) scale(0.95);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>